
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <p>    
        作业 6
        实现随机播放
            0, 用一个数组存储所有的音乐路径
            1, audio 标签有一个 ended 事件, 会在播放结束后触发
                用这个事件实现播放结束自动播放一首歌(这首歌是从数组中随机选择的, 不需要考虑随机的还是当前这首歌的情况)
        
            提示: 实现一个 choice 函数，随机返回数组中的一个元素
            const choice = function(array) {
                // 1. 得到  0 - 1 之间的小数 a
                // 2. 把 a 转成 0 - array.length 之间的小数
                // 3. 得到 0 - array.length - 1 之间的整数作为下标
                // 4. 得到 array 中的随机元素
            }
    </p>

    <audio id="music-play" src="周杰伦 - 我不配.wav" controls="controls" data-info="周杰伦 - 我不配.wav"></audio>

    <section>
        <button id="change-up"><</button>
        <button id="play-ct">P</button>
        <button id="pause-ct">T</button>
        <button id="change-down">></button>
        <button id="loop" data-loopstu="1" >loop</button>
        <button id="rand-song" data-random="1" >#@$%^</button>
        <p><span id="time-ct"></span></p>

    </section>

    <ul>
        <div data-path="周杰伦 - 我不配.wav" class="song">我不配 - 周杰伦</div>
        <div data-path="听妈妈的话.mp3" class="song">听妈妈的话</div>
        <div data-path="菊花台-周杰伦.mp3" class="song">菊花台-周杰伦</div>
        <div data-path="周杰伦 - Ending.mp3" class="song">周杰伦 - Ending</div>
        <div data-path="周杰伦 - 简单爱.mp3" class="song">周杰伦 - 简单爱</div>
    </ul>
    <h3 id="show-name"></h3>


</body>
<script>
    var mucis_play = document.querySelector('#music-play')
    var time_span = document.querySelector('#time-ct')
    const songs_list = [
        '周杰伦 - 我不配.wav',
        '周杰伦 - 听妈妈的话.mp3',
        '周杰伦 - 菊花台.mp3',
        '周杰伦 - Ending.mp3',
        '周杰伦 - 简单爱.mp3',
    ]

    const bindAll = function(elements, eventName, callback) {
        for (let i = 0; i < elements.length; i++) {
            let tag = elements[i]
            tag.addEventListener(eventName, callback)
        }
    }

    var index = 0
    //负责，逻辑处理，根据当前循环、随机按钮状态，返回一个歌曲链接
    const nextSong = function(mucis_play) {
        if (loop_stu == 0 && rand_stu == 0) {
            console.log("sequence")
            index = (index + 1) % songs_list.length
        } else if (loop_stu == 1) {
            console.log("is loop")
            // mucis_play.currentTime = 0
            // mucis_play.play()
            // console.log(`当前歌曲is ${mucis_play}`)
            console.log(mucis_play.src)
            console.log("您都设置了循环了，还一直点下一首干嘛？")
            return mucis_play.src

        } else if (rand_stu == 1) {
            index = randomChoice(songs_list)
            console.log(`随机得到歌曲is is ${songs_list[index]}`)
        }    
            
        return songs_list[index]
    }

    const upSong = function() {
        if (loop_stu == 0 && rand_stu == 0) {
            console.log("sequence")
            index = (index - 1)
            console.log(songs_list.length)
            if (index < 0) {
                index = songs_list.length - 1
            }
            console.log(`up song's index is ${index}`)
        } else if (loop_stu == 1) {
            console.log("is loop")
            console.log("您都设置了循环了，还一直点下一首干嘛？")
            return mucis_play.src

        } else if (rand_stu == 1) {
            index = randomChoice(songs_list)
            console.log(`随机得到歌曲is is ${songs_list[index]}`)
        }  
        return songs_list[index]
    }



    const bindEventPlay = function(mucis_play) {
        let play_ct = document.querySelector('#play-ct')
        play_ct.addEventListener('click', function() {
            console.log(mucis_play.dataset.info)
            mucis_play.play()
        })
    }

    const bindEventPause = function(mucis_play) {
        let pause_ct = document.querySelector('#pause-ct')
        pause_ct.addEventListener('click', function() {
            mucis_play.pause()
        })
    }


    const bindEventUp = function(mucis_play) {
        let up_song = document.querySelector('#change-up')
        up_song.addEventListener('click', function() {
            let up_song_src = upSong()
                mucis_play.src = up_song_src
                mucis_play.addEventListener('canplay', function() {
                
                mucis_play.play()
            })
        })
    }

    const bindEventNext = function(mucis_play) {
        let next_song = document.querySelector('#change-down')
        next_song.addEventListener('click', function() {
            let next_song_src = nextSong(mucis_play)
            mucis_play.src = next_song_src
            mucis_play.addEventListener('canplay', function() {
                mucis_play.play()
            })

        })
    }


    //循环开关
    let loop_stu = 0
    const bindEventLoop = function(mucis_play) {
        let loop_stu_button = document.querySelector('#loop')
        //总觉的这个东西有点不对劲，html 都设置了自定义属性，这里又自己定义了一个变量。
        // 多余了一个。
        loop_stu = loop_stu_button.dataset.loopstu

        loop_stu_button.addEventListener('click', function() {
            if (loop_stu == 1) {
                loop_stu = 0
                console.log(`no loop`)
            } else {
                loop_stu = 1
                // 随机和循环不能同时设定
                rand_stu = 0
                console.log(`looping`)
            }
            console.log(`此时loop rand 的状态is : ${loop_stu} ,${rand_stu}`)
        })
    }

    //随机返回songs_list 列表范围的数字下表
    const randomChoice = function(array) {
        let find_song_index = parseInt((Math.random() * array.length) )
        console.log(`song's index is :${find_song_index}`)

        return find_song_index
    }
    //随机状态开关
    let rand_stu = 0
    const bindEventRand = function(mucis_play) {
        let rand_stu_button = document.querySelector('#rand-song')
        //越写越感觉这东西多余，rand_stu_button.dataset.random
        rand_stu = rand_stu_button.dataset.random

        rand_stu_button.addEventListener('click', function() {
            if (rand_stu == 1) {
                rand_stu = 0
                console.log(`no random`)
            } else {
                rand_stu = 1
                //不能同时设定
                loop_stu = 0
                console.log(`randomming`)
            }
            console.log(`此时loop rand 的状态is : ${loop_stu} ,${rand_stu}`)
        })
        
    }

    const playSong = (info)=> {
        console.log(info)
    }


    const bindEventListChangeSong = function(mucis_play) {
        let one_song = document.querySelectorAll('.song')
        bindAll(one_song, 'click', function(event) {
            let self = event.target
            let data_change_src = self.dataset.path
            mucis_play.src = data_change_src
            mucis_play.addEventListener('canplay', function(data_change_src) {
                mucis_play.play()
            })
        })
    }

    const bindEventEnded = function(mucis_play) {
        mucis_play.addEventListener('ended', function() {
            console.log('播放完毕')
            //拿到歌曲链接
            let next_song_src = nextSong(mucis_play)
            //修改歌曲链接
            mucis_play.src = next_song_src
            mucis_play.addEventListener('canplay', function() {
                mucis_play.play()
            })
            
        })
    }

    const bindEvents = function() {
        
        bindEventPlay(mucis_play)
        bindEventPause(mucis_play)
        bindEventListChangeSong(mucis_play)
        bindEventEnded(mucis_play)
        bindEventLoop(mucis_play)
        bindEventRand(mucis_play)
        bindEventUp(mucis_play)
        bindEventNext(mucis_play)
    }

    var changeinfo = document.querySelector('#show-name')
    const changeInfo = () => {
        let url = decodeURIComponent(mucis_play.src)
        let start_index = url.lastIndexOf('/')
        let info = url.slice(start_index + 1,)
        console.log(info)
        changeinfo.innerHTML = info
    }
    
    //网上查的
    function tenDigit(time){
      return time<10? '0'+time : time;
    }

    let time_status = setInterval(function() {

        changeInfo()
        var all_minutes = parseInt(mucis_play.duration / 60, 10)
        var all_seconds = parseInt(mucis_play.duration % 60, 10)
        var all_time = `${all_minutes}:${all_seconds}`

        var now_seconds = parseInt(mucis_play.currentTime % 60, 10)
        var now_minutes = parseInt(mucis_play.currentTime / 60, 10)
        var now_time = tenDigit(now_minutes) + ":" + tenDigit(now_seconds)

        time_span.innerHTML = `${now_time} / ${all_time}`    

    }, 500);

    bindEvents()

</script>
</html>